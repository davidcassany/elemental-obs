name: Update OBS sources

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch to upgrade in OBS'
        required: true
        default: 'dev'

concurrency:
  group: soucre-update-${{ inputs.target_branch }}

permissions:
  contents: write

jobs:
  update-sources:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target branch
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.target_branch }}
        token: ${{ secrets.PAT }}
    - name: Checkout builders
      run: |
        set -x
        
        [ -d builders ] && exit 1
        [ -f Makefile ] && exit 1

        git fetch origin +${{ github.ref_name }}:${{ github.ref_name }}
        git checkout ${{ github.ref_name }} -- scripts Makefile config.yaml
    - name: Run prepare-sources
      env:
        V_OFFSET: no
        V_PARSE: patch
      run: |
        count=$(yq ".${{ inputs.target_branch }} | length" config.yaml)

        for ((n=0;n<${count};n++)); do
          export REPO="$(yq ".${{ inputs.target_branch }}.[${n}].repo" config.yaml)"
          export BRANCH="$(yq ".${{ inputs.target_branch }}.[${n}].branch" config.yaml)"
          export V_PARSE="$(yq ".${{ inputs.target_branch }}.[${n}].parseVersion" config.yaml)"
          export V_OFFSET="$(yq ".${{ inputs.target_branch }}.[${n}].versionOffset" config.yaml)"

          make prepare-sources
        done
    - name: Update sources
      run: |
        make update-sources 
    - name: Clean paths
      run: |
        rm -rf scripts
        rm -f Makefile config.yaml
    - name: Checkout new branch ${{ inputs.target_branch }}_stage
      id: commit
      env:
        GH_TOKEN: ${{ secrets.PAT }}
      run: |
        # TODO set an OBS user as this might be used for *.changes generation
        git config --global user.email "do-not-use@elemental.suse.com"
        git config --global user.name "GitHub Action Runner"

        git checkout -b ${{ inputs.target_branch }}_stage
        git add .

        if [ -z "$(git status --porcelain)" ]; then
          echo "Clean work tree, nothing to do"
          echo "clean=true" >> "${GITHUB_OUTPUT}"
          exit 0
        else
          echo "clean=false" >> "${GITHUB_OUTPUT}"
        fi

        git commit -s -m "Automated commit from GHA workflow"
        git push origin ${{ inputs.target_branch }}_stage --force
    - if: ${{ steps.commit.outputs.clean != 'true' }} 
      name: Update/create PR
      env:
        GH_TOKEN: ${{ secrets.PAT }}
      run: |
        json=$(gh pr list --repo ${{ github.repository }} --json number,baseRefName,headRefName --head ${{ inputs.target_branch }}_stage --base ${{ inputs.target_branch }} --limit 1)

        if [ "$(echo "${json}" | jq length)" -eq 1 ]; then
          number="$(echo "${json}" | jq '.[0].number')"
          gh pr comment "${number}" --repo ${{ github.repository }} --body "Updating PR from sources"
        else
          gh pr create --repo ${{ github.repository }} --head ${{ inputs.target_branch }}_stage --base ${{ inputs.target_branch }} \
            --body "Automated PR from GH client" --title "Update '${{ inputs.target_branch }}' OBS sources"
        fi
